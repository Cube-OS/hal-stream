name: Release

on:
  push:
    branches:
      - main # Trigger workflow on push or pull request to the main branch

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Check for version change
      id: check_version
      run: |
        VERSION_CHANGE=$(git diff HEAD^ HEAD -- Cargo.toml | grep "^+version" || true)
        if [[ -n "$VERSION_CHANGE" ]]; then
          echo "::set-output name=version_changed::true"
        else
          echo "::set-output name=version_changed::false"
        fi    
    
    - name: Build, test, package, tag and push
      if: steps.check_version.outputs.version_changed == 'true'
      run: |
        cargo build --release
        cargo test
        cargo package
        VERSION=$(grep "^version" Cargo.toml | cut -d' ' -f3 | tr -d '"')
        TAG_NAME="v$VERSION"
        echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
        git tag $TAG_NAME
        git push origin ${{ env.TAG_NAME }}